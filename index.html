<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AAæ”¶æ•¸ç¥å™¨</title>
    
    <!-- è§£æ±ºäº‚ç¢¼å•é¡Œçš„é—œéµè¨­å®š -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <!-- Tailwind CSS (æ¨£å¼åº«) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- åŠ å…¥ Babel ç”¨æ–¼å³æ™‚ç·¨è­¯ JSX (é–å®šç‰ˆæœ¬ä»¥ä¿®å¾© .targets["esmodules"] éŒ¯èª¤) -->
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>

    <!-- è¼‰å…¥ React å’Œ Lucide åœ–æ¨™åº« (ä½¿ç”¨ ES Modules) -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>

    <style>
        /* æ–°å¢ï¼šè‡ªå®šç¾©å¯è¦‹æ»¾å‹•æ¢ (ç”¨æ–¼å¤šäººåå–®) */
        .custom-scrollbar {
            -webkit-overflow-scrolling: touch; /* iOS æµæš¢æ»¾å‹• */
        }
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px; /* æ©«å‘æ»¾å‹•æ¢é«˜åº¦ */
            width: 6px;  /* ç¸±å‘æ»¾å‹•æ¢å¯¬åº¦ */
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }

        /* é˜²æ­¢ iOS é»æ“Šé«˜äº® */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background-color: #f9fafb; /* bg-gray-50 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- æ³¨æ„é€™è£¡æ”¹æˆäº† type="text/babel" ä¸¦åŠ ä¸Š data-type="module" -->
    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Plus, Trash2, User, DollarSign, Users, Receipt, Share2, Copy, CheckCircle, Wallet, List, Calculator, RotateCcw, AlertCircle, X, CheckSquare, Square, ArrowRightLeft, UserCheck } from 'lucide-react';

        const App = () => {
            // --- ç‹€æ…‹ç®¡ç† (åŠ å…¥ LocalStorage è®€å–) ---
            const [users, setUsers] = useState(() => {
                try {
                const savedUsers = localStorage.getItem('aa_users');
                // é è¨­åªæœ‰ 'æˆ‘'
                return savedUsers ? JSON.parse(savedUsers) : ['æˆ‘'];
                } catch (e) {
                return ['æˆ‘'];
                }
            });

            const [newUser, setNewUser] = useState('');
            
            const [expenses, setExpenses] = useState(() => {
                try {
                const savedExpenses = localStorage.getItem('aa_expenses');
                return savedExpenses ? JSON.parse(savedExpenses) : [];
                } catch (e) {
                return [];
                }
            });

            const [newExpense, setNewExpense] = useState({
                title: '',
                amount: '',
                payer: users[0] || 'æˆ‘',
                involved: [] // [] ä»£è¡¨é è¨­å…¨å“¡, ['__NONE__'] ä»£è¡¨å…¨ä¸é¸
            });

            // æ–°å¢ï¼šçµç®—æ¨¡å¼ç‹€æ…‹ 'smart' | 'banker'
            const [settlementMode, setSettlementMode] = useState('smart');
            // æ–°å¢ï¼šé›†ä¸­æ”¶æ•¸äºº
            const [banker, setBanker] = useState(users[0] || 'æˆ‘');

            const [activeTab, setActiveTab] = useState('input'); // 'input' | 'expenses' | 'result'
            const [copySuccess, setCopySuccess] = useState(false);

            // --- è‡ªå®šç¾©ç¢ºèªè¦–çª—ç‹€æ…‹ ---
            const [modal, setModal] = useState({
                isOpen: false,
                title: '',
                message: '',
                type: 'confirm', // 'confirm' | 'alert'
                onConfirm: () => {}
            });

            // é˜²æ­¢ iOS è¼¸å…¥æ™‚è‡ªå‹•æ”¾å¤§ (å­—é«”éœ€ >= 16px)
            const inputBaseClass = "w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-base text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all";

            // --- è‡ªå‹•å„²å­˜ (Auto Save) ---
            useEffect(() => {
                localStorage.setItem('aa_users', JSON.stringify(users));
            }, [users]);

            useEffect(() => {
                localStorage.setItem('aa_expenses', JSON.stringify(expenses));
            }, [expenses]);

            // ç•¶ä½¿ç”¨è€…åˆ—è¡¨è®Šæ›´æ™‚ï¼Œç¢ºä¿ newExpense.payer å’Œ banker æ˜¯æœ‰æ•ˆçš„
            useEffect(() => {
                if (!users.includes(newExpense.payer) && users.length > 0) {
                    setNewExpense(prev => ({ ...prev, payer: users[0] }));
                }
                if (!users.includes(banker) && users.length > 0) {
                    setBanker(users[0]);
                }
            }, [users, newExpense.payer, banker]);


            // --- Helper: é–‹å•Ÿæ¨¡æ…‹è¦–çª— ---
            const showConfirm = (title, message, onConfirm) => {
                setModal({ isOpen: true, title, message, type: 'confirm', onConfirm });
            };

            const showAlert = (title, message) => {
                setModal({ isOpen: true, title, message, type: 'alert', onConfirm: () => {} });
            };

            const closeModal = () => {
                setModal(prev => ({ ...prev, isOpen: false }));
            };


            // --- æ¸…é™¤æ•¸æ“šåŠŸèƒ½ ---
            const handleClearAll = () => {
                showConfirm(
                'æ¸…é™¤æ•¸æ“š',
                'ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ•¸æ“šå—ï¼Ÿé€™å°‡æœƒåˆªé™¤æ‰€æœ‰åƒèˆ‡è€…å’Œæ¶ˆè²»è¨˜éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚',
                () => {
                    const defaultUsers = ['æˆ‘'];
                    setUsers(defaultUsers);
                    setExpenses([]);
                    setNewExpense({
                    title: '',
                    amount: '',
                    payer: defaultUsers[0],
                    involved: []
                    });
                    setSettlementMode('smart');
                    setBanker(defaultUsers[0]);
                    localStorage.removeItem('aa_users');
                    localStorage.removeItem('aa_expenses');
                    setActiveTab('input');
                    if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
                }
                );
            };

            // --- åƒèˆ‡è€…é‚è¼¯ ---
            const addUser = () => {
                if (newUser.trim() && !users.includes(newUser.trim())) {
                setUsers([...users, newUser.trim()]);
                setNewUser('');
                }
            };

            const removeUser = (nameToRemove) => {
                if (users.length <= 1) {
                showAlert('ç„¡æ³•åˆªé™¤', 'æœ€å°‘è¦æœ‰ä¸€å€‹åƒèˆ‡è€…');
                return;
                }
                
                showConfirm(
                'åˆªé™¤åƒèˆ‡è€…',
                `ç¢ºå®šè¦åˆªé™¤ "${nameToRemove}" å—ï¼Ÿ\næ¶‰åŠè©²äººçš„æ¶ˆè²»è¨˜éŒ„ä¹Ÿæœƒè¢«æ›´æ–°ã€‚`,
                () => {
                    setUsers(users.filter(u => u !== nameToRemove));
                    // æ›´æ–°ç›¸é—œæ¶ˆè²»è¨˜éŒ„
                    setExpenses(expenses.map(exp => ({
                    ...exp,
                    involved: exp.involved.filter(u => u !== nameToRemove),
                    payer: exp.payer === nameToRemove ? users.find(u => u !== nameToRemove) || 'Unknown' : exp.payer
                    })));
                }
                );
            };

            // --- æ¶ˆè²»è¨˜éŒ„é‚è¼¯ & å…¨é¸/å…¨ä¸é¸ ---
            const handleSelectAll = () => {
                setNewExpense({ ...newExpense, involved: [] }); // ç©ºé™£åˆ— = é è¨­å…¨å“¡
            };

            const handleSelectNone = () => {
                setNewExpense({ ...newExpense, involved: ['__NONE__'] }); // ç‰¹æ®Šæ¨™è¨˜ = æ²’äºº
            };

            const toggleInvolved = (userName) => {
                let currentInvolved;
                
                if (newExpense.involved.includes('__NONE__')) {
                    currentInvolved = [];
                } 
                else if (newExpense.involved.length === 0) {
                    currentInvolved = [...users];
                } 
                else {
                    currentInvolved = [...newExpense.involved];
                }

                if (currentInvolved.includes(userName)) {
                    const updated = currentInvolved.filter(u => u !== userName);
                    if (updated.length === 0) {
                        setNewExpense({ ...newExpense, involved: ['__NONE__'] });
                    } else {
                        setNewExpense({ ...newExpense, involved: updated });
                    }
                } else {
                    setNewExpense({ ...newExpense, involved: [...currentInvolved, userName] });
                }
            };

            const addExpense = () => {
                if (!newExpense.title || !newExpense.amount) return;
                
                let finalInvolved = [];
                if (newExpense.involved.length === 0) {
                    finalInvolved = users; // é è¨­å…¨å“¡
                } else {
                    finalInvolved = newExpense.involved.filter(u => u !== '__NONE__');
                }

                if (finalInvolved.length === 0) {
                    showAlert('æç¤º', 'è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åˆ†æ“”äºº (æ¶‰åŠé‚Šå€‹)');
                    return;
                }

                const expenseItem = {
                    id: Date.now(),
                    title: newExpense.title,
                    amount: parseFloat(newExpense.amount),
                    payer: newExpense.payer,
                    involved: finalInvolved,
                    date: new Date().toLocaleTimeString()
                };

                setExpenses([expenseItem, ...expenses]); 
                setNewExpense({ title: '', amount: '', payer: users[0], involved: [] }); 
                if (navigator.vibrate) navigator.vibrate(50);
            };

            const removeExpense = (id) => {
                showConfirm(
                'åˆªé™¤è¨˜éŒ„',
                'ç¢ºå®šåˆªé™¤é€™ç­†æ¶ˆè²»è¨˜éŒ„ï¼Ÿ',
                () => {
                    setExpenses(expenses.filter(e => e.id !== id));
                }
                );
            };


            // --- æ ¸å¿ƒè¨ˆç®—é‚è¼¯ ---
            const settlement = useMemo(() => {
                // 1. è¨ˆç®—æ¯å€‹äººçš„æ·¨æ”¶æ”¯
                let balances = {};
                users.forEach(u => balances[u] = 0);

                const totalSpent = expenses.reduce((acc, curr) => acc + curr.amount, 0);

                expenses.forEach(exp => {
                const payer = exp.payer;
                const amount = exp.amount;
                const involvedPeople = exp.involved;
                
                if (involvedPeople.length === 0) return;
                const splitAmount = amount / involvedPeople.length;

                if (balances[payer] !== undefined) balances[payer] += amount;
                involvedPeople.forEach(person => {
                    if (balances[person] !== undefined) balances[person] -= splitAmount;
                });
                });

                let transactions = [];

                if (settlementMode === 'smart') {
                    // --- æ™ºèƒ½æ¨¡å¼ (æœ€å°‘è½‰å¸³æ¬¡æ•¸) ---
                    let debtors = [];
                    let creditors = [];

                    Object.keys(balances).forEach(user => {
                        const amount = balances[user];
                        if (amount < -0.01) debtors.push({ user, amount }); 
                        if (amount > 0.01) creditors.push({ user, amount }); 
                    });

                    debtors.sort((a, b) => a.amount - b.amount); 
                    creditors.sort((a, b) => b.amount - a.amount); 

                    let i = 0; 
                    let j = 0; 

                    while (i < debtors.length && j < creditors.length) {
                        const debtor = debtors[i];
                        const creditor = creditors[j];
                        const amount = Math.min(Math.abs(debtor.amount), creditor.amount);

                        transactions.push({
                            from: debtor.user,
                            to: creditor.user,
                            amount: amount.toFixed(1) 
                        });

                        debtor.amount += amount;
                        creditor.amount -= amount;

                        if (Math.abs(debtor.amount) < 0.01) i++;
                        if (creditor.amount < 0.01) j++;
                    }
                } else {
                    // --- é›†ä¸­æ”¶æ•¸æ¨¡å¼ ---
                    // é‚è¼¯ï¼š
                    // 1. æ¬ éŒ¢çš„äºº(Balance < 0) -> è½‰çµ¦ Banker
                    // 2. Banker -> è½‰çµ¦å¤šä»˜éŒ¢çš„äºº(Balance > 0ï¼Œä¸”ä¸æ˜¯ Banker æœ¬äºº)
                    const currentBanker = users.includes(banker) ? banker : users[0];

                    Object.keys(balances).forEach(user => {
                        if (user === currentBanker) return; // Banker ä¸ç”¨è½‰çµ¦è‡ªå·±

                        const amount = balances[user];
                        
                        if (amount < -0.01) {
                            // æ¬ éŒ¢ï¼Œçµ¦ Banker
                            transactions.push({
                                from: user,
                                to: currentBanker,
                                amount: Math.abs(amount).toFixed(1)
                            });
                        } else if (amount > 0.01) {
                            // æ”¶éŒ¢ï¼ŒBanker çµ¦ä»–
                            transactions.push({
                                from: currentBanker,
                                to: user,
                                amount: amount.toFixed(1)
                            });
                        }
                    });
                }

                return { transactions, totalSpent, balances };
            }, [users, expenses, settlementMode, banker]);

            // --- è¤‡è£½æ–‡å­—åŠŸèƒ½ ---
            const copyToClipboard = () => {
                const modeText = settlementMode === 'smart' ? 'æ™ºèƒ½è½‰å¸³' : `é›†ä¸­æ”¶æ•¸ (${banker})`;
                let text = `ğŸ§¾ *AAæ”¶æ•¸çµç®—* [${modeText}]\n`;
                text += `ç¸½æ¶ˆè²»: $${settlement.totalSpent.toFixed(1)}\n\n`;
                
                if (settlement.transactions.length === 0) {
                     text += `ç„¡é ˆè½‰å¸³\n`;
                } else {
                    settlement.transactions.forEach(t => {
                        text += `ğŸ”´ ${t.from} çµ¦ ${t.to}: $${t.amount}\n`;
                    });
                }
                
                text += `\n--------\nGenerated by AAæ”¶æ•¸ç¥å™¨`;
                
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                document.execCommand('copy');
                setCopySuccess(true);
                if (navigator.vibrate) navigator.vibrate(100);
                setTimeout(() => setCopySuccess(false), 2000);
                } catch (err) {
                console.error('Copy failed', err);
                }
                document.body.removeChild(textArea);
            };

            // --- æ»¾å‹•åˆ°é ‚éƒ¨ç•¶åˆ‡æ› Tab æ™‚ ---
            useEffect(() => {
                window.scrollTo(0, 0);
            }, [activeTab]);

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col font-sans max-w-md mx-auto shadow-2xl relative">
                
                {/* è‡ªå®šç¾©ç¢ºèªè¦–çª— (Modal) */}
                {modal.isOpen && (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                        <div 
                        className="absolute inset-0 bg-black/40 backdrop-blur-sm animate-in fade-in duration-200"
                        onClick={closeModal}
                        ></div>
                        <div className="bg-white rounded-2xl w-full max-w-xs shadow-2xl p-6 relative z-10 animate-in zoom-in-95 duration-200 border border-gray-100">
                            <div className="flex items-center gap-3 mb-3">
                            {modal.type === 'alert' ? <AlertCircle className="text-red-500" /> : <AlertCircle className="text-indigo-500" />}
                            <h3 className="text-lg font-bold text-gray-800">{modal.title}</h3>
                            </div>
                            <p className="text-gray-600 text-sm mb-6 whitespace-pre-line leading-relaxed">
                                {modal.message}
                            </p>
                            <div className="flex gap-3">
                                {modal.type === 'confirm' && (
                                    <button 
                                        onClick={closeModal}
                                        className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-medium text-sm hover:bg-gray-200 transition-colors"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                )}
                                <button 
                                    onClick={() => {
                                        modal.onConfirm();
                                        closeModal();
                                    }}
                                    className={`flex-1 py-3 rounded-xl font-bold text-sm text-white shadow-lg transition-transform active:scale-95 ${
                                        modal.type === 'alert' ? 'bg-gray-800 hover:bg-gray-900' : 'bg-red-500 hover:bg-red-600 shadow-red-200'
                                    }`}
                                >
                                    {modal.type === 'alert' ? 'çŸ¥é“äº†' : 'ç¢ºå®šåŸ·è¡Œ'}
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Mobile Header */}
                <div className="bg-indigo-600 px-6 pt-8 pb-6 text-white rounded-b-[2rem] shadow-lg relative z-10 shrink-0">
                    <div className="flex justify-between items-start">
                    <div>
                        <h1 className="text-2xl font-bold flex items-center gap-2">
                        <Receipt className="w-6 h-6" />
                        AAæ”¶æ•¸ç¥å™¨
                        </h1>
                        <p className="text-indigo-200 text-xs mt-1">Total: ${settlement.totalSpent.toFixed(1)}</p>
                    </div>
                    
                    <div className="flex gap-2">
                        <div className="bg-white/20 px-3 py-2 rounded-xl text-xs font-medium backdrop-blur-sm flex items-center">
                        {users.length} äºº
                        </div>
                        {/* æ¸…é™¤æ•¸æ“šæŒ‰éˆ• */}
                        <button 
                            onClick={handleClearAll}
                            className="bg-red-500/80 hover:bg-red-500 px-3 py-2 rounded-xl text-white backdrop-blur-sm transition-colors flex items-center justify-center"
                            title="æ¸…é™¤æ‰€æœ‰æ•¸æ“š"
                        >
                            <Trash2 size={16} />
                        </button>
                    </div>
                    </div>
                </div>

                {/* Main Content Area - Padding Bottom ç‚ºäº†é¿é–‹ Bottom Nav */}
                <div className="flex-1 overflow-y-auto p-4 pb-32">
                    
                    {/* TAB 1: è¨˜å¸³ (Input) */}
                    {activeTab === 'input' && (
                    <div className="space-y-5 animate-in fade-in zoom-in duration-300">
                        
                        {/* 1. åƒèˆ‡è€…è¨­å®š (å¯æ”¶åˆæˆ–ç²¾ç°¡) */}
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <div className="flex justify-between items-center mb-3">
                            <h2 className="text-sm font-bold text-gray-700 flex items-center gap-2">
                            <Users size={16} className="text-indigo-500"/> 
                            ç®¡ç†åƒèˆ‡è€…
                            </h2>
                        </div>
                        
                        {/* æ©«å‘æ»¾å‹•çš„äººå“¡åˆ—è¡¨ */}
                        <div className="flex gap-2 overflow-x-auto pb-2 mb-2 custom-scrollbar">
                            {users.map((u, idx) => (
                            <div key={idx} className="bg-gray-100 text-gray-700 px-3 py-1.5 rounded-full text-sm flex items-center gap-2 whitespace-nowrap shrink-0 border border-gray-200">
                                {u}
                                {users.length > 1 && (
                                <button onClick={() => removeUser(u)} className="text-gray-400 hover:text-red-500 p-1 -mr-1">
                                    <Trash2 size={12} />
                                </button>
                                )}
                            </div>
                            ))}
                            <div className="w-2 shrink-0"></div> {/* Spacer */}
                        </div>

                        <div className="flex gap-2">
                            <input 
                            type="text" 
                            value={newUser}
                            onChange={(e) => setNewUser(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && addUser()}
                            placeholder="åŠ äººå (ä¾‹: Amy)"
                            className={`${inputBaseClass} py-2`}
                            />
                            <button 
                            onClick={addUser} 
                            disabled={!newUser}
                            className="bg-indigo-600 text-white px-4 rounded-xl hover:bg-indigo-700 disabled:bg-gray-300 transition-colors"
                            >
                            <Plus size={20} />
                            </button>
                        </div>
                        </div>

                        {/* 2. æ–°å¢æ¶ˆè²»å¡ç‰‡ */}
                        <div className="bg-white p-5 rounded-2xl shadow-md border border-indigo-50">
                        <div className="flex items-center gap-2 mb-4">
                            <div className="bg-indigo-100 p-2 rounded-lg text-indigo-600">
                            <Wallet size={20} />
                            </div>
                            <h2 className="text-lg font-bold text-gray-800">è¨˜ä¸€ç­†</h2>
                        </div>
                        
                        <div className="space-y-4">
                            {/* é‡‘é¡è¼¸å…¥ - æ”¾å¤§å­—é«” */}
                            <div className="relative">
                            <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xl">$</div>
                            <input 
                                type="number" 
                                inputMode="decimal" 
                                placeholder="0.00"
                                value={newExpense.amount}
                                onChange={(e) => setNewExpense({...newExpense, amount: e.target.value})}
                                className="w-full pl-10 bg-gray-50 border-2 border-transparent focus:border-indigo-500 rounded-2xl px-4 py-4 text-3xl font-bold text-gray-800 focus:outline-none placeholder-gray-300 transition-all text-center"
                            />
                            </div>

                            {/* é …ç›®åç¨± */}
                            <div>
                            <input 
                                type="text" 
                                placeholder="æ¶ˆè²»é …ç›® (ä¾‹: æ™šé¤)"
                                value={newExpense.title}
                                onChange={(e) => setNewExpense({...newExpense, title: e.target.value})}
                                className={inputBaseClass}
                            />
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                            {/* ä»˜æ¬¾äºº */}
                            <div>
                                <label className="block text-xs font-medium text-gray-400 mb-1 ml-1">èª°å…ˆä»˜?</label>
                                <div className="relative">
                                <select 
                                    value={newExpense.payer}
                                    onChange={(e) => setNewExpense({...newExpense, payer: e.target.value})}
                                    className={`${inputBaseClass} appearance-none pr-8`}
                                >
                                    {users.map(u => <option key={u} value={u}>{u}</option>)}
                                </select>
                                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                    <User size={14} />
                                </div>
                                </div>
                            </div>
                            </div>

                            {/* æ¶‰åŠäººå“¡ - æ”¹ç‚ºæ›´æ˜“é»æ“Šçš„å€å¡Š */}
                            <div>
                                <div className="flex justify-between items-end mb-2 ml-1">
                                    <label className="block text-xs font-medium text-gray-400">
                                        åˆ†æ¯”é‚Šå€‹? <span className="text-gray-300 font-normal">(é è¨­: å…¨å“¡)</span>
                                    </label>
                                    <div className="flex gap-2">
                                        <button onClick={handleSelectAll} className="flex items-center gap-1 text-[10px] bg-indigo-50 hover:bg-indigo-100 px-2 py-1 rounded text-indigo-600 transition-colors">
                                            <CheckSquare size={12} /> å…¨é¸
                                        </button>
                                        <button onClick={handleSelectNone} className="flex items-center gap-1 text-[10px] bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-gray-500 transition-colors">
                                            <Square size={12} /> æ¸…ç©º
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="flex gap-2 overflow-x-auto pb-2 custom-scrollbar -mx-1 px-1">
                                    {users.map(u => {
                                    const isSelected = (newExpense.involved.length === 0) 
                                        ? true 
                                        : (newExpense.involved.includes('__NONE__') 
                                            ? false 
                                            : newExpense.involved.includes(u));

                                    return (
                                        <button
                                        key={u}
                                        onClick={() => toggleInvolved(u)}
                                        className={`px-4 py-2 rounded-xl text-sm whitespace-nowrap shrink-0 transition-all border ${
                                            isSelected 
                                            ? 'bg-indigo-600 border-indigo-600 text-white shadow-md shadow-indigo-200' 
                                            : 'bg-white border-gray-200 text-gray-400'
                                        }`}
                                        >
                                        {u}
                                        </button>
                                    );
                                    })}
                                </div>
                            </div>

                            <button 
                            onClick={addExpense}
                            disabled={!newExpense.title || !newExpense.amount}
                            className="w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg shadow-xl shadow-gray-200 hover:bg-black disabled:opacity-50 disabled:cursor-not-allowed mt-4 active:scale-95 transition-transform flex items-center justify-center gap-2"
                            >
                            <Plus size={24} />
                            åŠ å…¥æ¸…å–®
                            </button>
                        </div>
                        </div>
                    </div>
                    )}

                    {/* TAB 2: æ¶ˆè²»æ˜ç´° (List) */}
                    {activeTab === 'expenses' && (
                    <div className="space-y-4 animate-in fade-in slide-in-from-right-4 duration-300">
                        <div className="flex justify-between items-center px-1">
                            <h2 className="text-lg font-bold text-gray-800">æ¶ˆè²»æ˜ç´° ({expenses.length})</h2>
                        </div>
                        {expenses.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                            <div className="bg-gray-100 p-4 rounded-full mb-4">
                                <List size={32} className="opacity-40" />
                            </div>
                            <p>æš«æ™‚æœªæœ‰æ¶ˆè²»</p>
                            <button onClick={() => setActiveTab('input')} className="mt-4 text-indigo-600 font-medium text-sm">
                            å»è¨˜ä¸€ç­† {'->'}
                            </button>
                        </div>
                        ) : (
                        expenses.map(exp => (
                            <div key={exp.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center group active:scale-[0.99] transition-transform">
                            <div className="flex-1 min-w-0 pr-4"> {/* min-w-0 for truncation */}
                                <div className="flex items-center gap-2 mb-1">
                                    <h3 className="font-bold text-gray-800 truncate">{exp.title}</h3>
                                    <span className="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">
                                    {new Date(exp.id).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    </span>
                                </div>
                                <div className="flex items-center gap-2 text-xs text-gray-500">
                                <span className="bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-md font-medium">
                                    {exp.payer} å…ˆä»˜
                                </span>
                                <span className="truncate max-w-[120px]">
                                    æ¶‰åŠ: {exp.involved.length === users.length ? 'å…¨å“¡' : exp.involved.join(', ')}
                                </span>
                                </div>
                            </div>
                            <div className="text-right shrink-0">
                                <div className="font-bold text-lg text-gray-800">${exp.amount}</div>
                                <button 
                                    onClick={() => removeExpense(exp.id)} 
                                    className="text-gray-300 p-2 -mr-2 hover:text-red-500 transition-colors"
                                >
                                <Trash2 size={16} />
                                </button>
                            </div>
                            </div>
                        ))
                        )}
                    </div>
                    )}

                    {/* TAB 3: çµç®—çµæœ (Result) */}
                    {activeTab === 'result' && (
                    <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
                        
                        {/* çµç®—å»ºè­°å¡ç‰‡ */}
                        <div className="bg-gradient-to-br from-gray-900 to-gray-800 p-6 rounded-2xl shadow-xl text-white overflow-hidden relative">
                        <div className="absolute top-0 right-0 p-4 opacity-10">
                            <Share2 size={100} />
                        </div>
                        
                        <div className="flex justify-between items-start mb-4 relative z-10">
                            <h2 className="text-lg font-bold flex items-center gap-2">
                                <Share2 size={20} className="text-green-400" /> 
                                å»ºè­°è½‰å¸³
                            </h2>
                        </div>

                        {/* çµç®—æ¨¡å¼åˆ‡æ› */}
                        <div className="relative z-10 bg-black/20 p-1 rounded-xl flex mb-4">
                            <button 
                                onClick={() => setSettlementMode('smart')}
                                className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-medium transition-all ${
                                    settlementMode === 'smart' ? 'bg-white/20 text-white shadow-sm' : 'text-gray-400 hover:text-white'
                                }`}
                            >
                                <ArrowRightLeft size={14} /> æ™ºèƒ½è½‰å¸³
                            </button>
                            <button 
                                onClick={() => setSettlementMode('banker')}
                                className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-medium transition-all ${
                                    settlementMode === 'banker' ? 'bg-white/20 text-white shadow-sm' : 'text-gray-400 hover:text-white'
                                }`}
                            >
                                <UserCheck size={14} /> é›†ä¸­æ”¶æ•¸
                            </button>
                        </div>

                        {/* é›†ä¸­æ”¶æ•¸æ¨¡å¼ï¼šé¸æ“‡æ”¶æ•¸äºº */}
                        {settlementMode === 'banker' && (
                            <div className="relative z-10 mb-4 animate-in fade-in slide-in-from-top-2 duration-200">
                                <div className="bg-white/10 border border-white/10 rounded-xl p-3 flex items-center justify-between">
                                    <span className="text-sm text-gray-300">èª°è² è²¬æ”¶éŒ¢?</span>
                                    <select 
                                        value={banker}
                                        onChange={(e) => setBanker(e.target.value)}
                                        className="bg-gray-800 text-white border border-gray-600 rounded-lg px-3 py-1 text-sm focus:outline-none focus:border-green-400"
                                    >
                                        {users.map(u => <option key={u} value={u}>{u}</option>)}
                                    </select>
                                </div>
                            </div>
                        )}
                        
                        {settlement.transactions.length === 0 ? (
                            <div className="text-center py-8 text-gray-400 bg-white/5 rounded-xl border border-white/5">
                            <CheckCircle className="w-12 h-12 mx-auto mb-3 text-green-500 opacity-80"/>
                            <p>æ¢æ•¸æ¸…æ™’ï¼æˆ–è€…æœªæœ‰è¼¸å…¥ã€‚</p>
                            </div>
                        ) : (
                            <div className="space-y-3 relative z-10">
                            {settlement.transactions.map((t, i) => (
                                <div key={i} className="bg-white/10 border border-white/10 p-4 rounded-xl flex items-center justify-between backdrop-blur-sm">
                                <div className="flex items-center gap-3">
                                    <div className="flex flex-col items-center">
                                        <span className="text-[10px] text-gray-400 mb-1 uppercase tracking-wider">Pay</span>
                                        <div className="px-3 py-1 bg-red-500/20 text-red-300 rounded-lg text-sm font-bold min-w-[60px] text-center">
                                            {t.from}
                                        </div>
                                    </div>
                                    <div className="text-gray-500">â†’</div>
                                    <div className="flex flex-col items-center">
                                        <span className="text-[10px] text-gray-400 mb-1 uppercase tracking-wider">Receive</span>
                                        <div className="px-3 py-1 bg-green-500/20 text-green-300 rounded-lg text-sm font-bold min-w-[60px] text-center">
                                            {t.to}
                                        </div>
                                    </div>
                                </div>
                                <div className="font-bold text-2xl text-white">
                                    <span className="text-sm font-normal text-gray-400 mr-1">$</span>
                                    {t.amount}
                                </div>
                                </div>
                            ))}
                            </div>
                        )}
                        </div>

                        {/* è¤‡è£½æŒ‰éˆ• */}
                        <button 
                        onClick={copyToClipboard}
                        disabled={settlement.transactions.length === 0}
                        className={`w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 ${
                            copySuccess 
                            ? 'bg-green-500 text-white' 
                            : 'bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-gray-300 disabled:shadow-none'
                        }`}
                        >
                        {copySuccess ? <CheckCircle size={20}/> : <Copy size={20}/>}
                        {copySuccess ? 'å·²è¤‡è£½ï¼' : 'è¤‡è£½çµæœ (Send to Group)'}
                        </button>

                        {/* è©³ç´°é¤˜é¡åˆ—è¡¨ */}
                        <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                        <h3 className="text-gray-400 text-xs font-bold mb-4 uppercase tracking-wider flex items-center gap-2">
                            <Calculator size={14}/>
                            å„äººæ·¨æ”¶æ”¯
                        </h3>
                        <div className="space-y-3">
                            {Object.entries(settlement.balances).map(([user, amount]) => (
                            <div key={user} className="flex justify-between items-center">
                                <span className="text-gray-700 font-medium text-sm">{user}</span>
                                <div className="flex items-center gap-2">
                                    {/* é€²åº¦æ¢è¦–è¦ºåŒ– (ç°¡å–®ç‰ˆ) */}
                                    <div className="w-16 h-1.5 bg-gray-100 rounded-full overflow-hidden hidden sm:block">
                                        <div 
                                            className={`h-full ${amount > 0 ? 'bg-green-400' : 'bg-red-400'}`} 
                                            style={{width: `${Math.min(Math.abs(amount) / (settlement.totalSpent || 1) * 100, 100)}%`}}
                                        ></div>
                                    </div>
                                    <span className={`font-bold font-mono ${amount > 0.01 ? 'text-green-600' : amount < -0.01 ? 'text-red-500' : 'text-gray-400'}`}>
                                    {amount > 0.01 ? `+$${amount.toFixed(1)}` : amount < -0.01 ? `-$${Math.abs(amount).toFixed(1)}` : '-'}
                                    </span>
                                </div>
                            </div>
                            ))}
                        </div>
                        </div>

                    </div>
                    )}
                </div>

                {/* Bottom Navigation Bar */}
                <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-2 pb-6 z-50 flex justify-between items-center text-xs font-medium text-gray-400 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                    <button 
                        onClick={() => setActiveTab('input')}
                        className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-colors ${activeTab === 'input' ? 'text-indigo-600' : 'hover:text-gray-600'}`}
                    >
                        <div className={`p-1 rounded-full ${activeTab === 'input' ? 'bg-indigo-50' : ''}`}>
                            <Plus size={24} strokeWidth={activeTab === 'input' ? 2.5 : 2} />
                        </div>
                        <span>è¨˜å¸³</span>
                    </button>

                    <button 
                        onClick={() => setActiveTab('expenses')}
                        className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-colors ${activeTab === 'expenses' ? 'text-indigo-600' : 'hover:text-gray-600'}`}
                    >
                        <div className={`p-1 rounded-full ${activeTab === 'expenses' ? 'bg-indigo-50' : ''}`}>
                            <List size={24} strokeWidth={activeTab === 'expenses' ? 2.5 : 2} />
                        </div>
                        <span>æ˜ç´°</span>
                    </button>

                    <button 
                        onClick={() => setActiveTab('result')}
                        className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-colors ${activeTab === 'result' ? 'text-indigo-600' : 'hover:text-gray-600'}`}
                    >
                        <div className={`p-1 rounded-full ${activeTab === 'result' ? 'bg-indigo-50' : ''}`}>
                            <Calculator size={24} strokeWidth={activeTab === 'result' ? 2.5 : 2} />
                        </div>
                        <span>çµç®—</span>
                    </button>
                </div>

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
